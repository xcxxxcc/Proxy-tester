// worker.js - simple proxy for video manifests (Cloudflare Worker)
addEventListener('fetch', event => event.respondWith(handle(event.request)))

async function handle(req) {
  const url = new URL(req.url);
  const target = url.searchParams.get('url') || url.pathname.replace('/proxy/','')
  if (!target) return new Response('Missing url', { status: 400 })

  try {
    // fetch target
    const out = await fetch(target, {
      method: req.method,
      headers: {
        "User-Agent": req.headers.get("user-agent") || "Mozilla/5.0",
        "Accept": "*/*",
        "Referer": req.headers.get("referer") || "https://www.youtube.com"
      }
    })
    // clone response and remove disallowed headers
    const resHeaders = new Headers(out.headers)
    // strip problematic headers
    resHeaders.delete('content-security-policy')
    resHeaders.delete('content-security-policy-report-only')
    resHeaders.delete('x-frame-options')
    resHeaders.set('access-control-allow-origin','*')
    resHeaders.set('access-control-allow-methods','GET,HEAD,OPTIONS')
    resHeaders.set('access-control-allow-headers','Range,Content-Type,Authorization')
    // preserve content-type
    const body = await out.arrayBuffer()
    return new Response(body, { status: out.status, headers: resHeaders })
  } catch (e) {
    return new Response('Worker fetch error: '+String(e), { status: 502 })
  }
}
