export default {
  async fetch(request) {
    const url = new URL(request.url);

    // ============================================
    // API EXTRACTOR (BEST, MASTER, ALL STREAM)
    // ============================================
    if (url.pathname === "/api/extract") {
      const target = url.searchParams.get("url");
      if (!target) {
        return new Response(JSON.stringify({ error: "no url" }), {
          headers: { "content-type": "application/json" },
        });
      }

      // PROXY (aman, tidak kena CORS)
      const proxy = `https://yt-dlp-proxy.warkoptevee.workers.dev/?url=${encodeURIComponent(
        target
      )}`;

      try {
        const x = await fetch(proxy);
        const data = await x.json();

        return new Response(JSON.stringify(data), {
          headers: { "content-type": "application/json" },
        });
      } catch (e) {
        return new Response(JSON.stringify({ error: e.toString() }), {
          headers: { "content-type": "application/json" },
        });
      }
    }

    // ==============================
    // HOME PAGE
    // ==============================
    if (url.pathname === "/" || url.pathname === "/index.html") {
      return new Response(INDEX_HTML, {
        headers: { "content-type": "text/html" },
      });
    }

    // ==============================
    // SCAN PAGE
    // ==============================
    if (url.pathname.startsWith("/scan")) {
      return new Response(SCAN_HTML, {
        headers: { "content-type": "text/html" },
      });
    }

    return new Response("404", { status: 404 });
  },
};

// ======================================================================
// INDEX PAGE – MENU BESAR + FITUR PROJECT LAMA
// ======================================================================
const INDEX_HTML = `
<!DOCTYPE html>
<html>
<head>
<title>WARKOP PANEL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  background:#000;
  color:#fff;
  font-family:Arial;
  padding:20px;
  text-align:center;
}
.btn {
  background:#111;
  color:#0f0;
  display:block;
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  text-decoration:none;
  font-size:22px;
}
</style>
</head>
<body>

<h1>WARKOP STREAM PANEL</h1>

<!-- GAME -->
<a class="btn" href="/scan?game=ML">Mobile Legends</a>
<a class="btn" href="/scan?game=HOK">Honor of Kings</a>
<a class="btn" href="/scan?game=DOTA2">DOTA 2</a>
<a class="btn" href="/scan?game=PUBG">PUBG Mobile</a>
<a class="btn" href="/scan?game=CS2">Counter Strike 2</a>
<a class="btn" href="/scan?game=LOL">League of Legends</a>
<a class="btn" href="/scan?game=VAL">Valorant</a>
<a class="btn" href="/scan?game=EFOOT">eFootball</a>

<!-- KATEGORI LAIN -->
<br><h2>Category</h2>
<a class="btn" href="/scan?cat=ANIME">ANIME</a>
<a class="btn" href="/scan?cat=BOLA">BOLA</a>
<a class="btn" href="/scan?cat=ESPORT">ESPORTS</a>

<br><br>
<h2>Custom Link</h2>
<a class="btn" href="/scan">Open Scanner</a>

</body>
</html>
`;

// ======================================================================
// SCAN PAGE – BEST STREAM, MASTER, ALL STREAM
// ======================================================================
const SCAN_HTML = `
<!DOCTYPE html>
<html>
<head>
<title>Extractor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#000; color:#fff; font-family:Arial; padding:20px; }
input {
  width:100%; padding:12px; margin:10px 0;
  border-radius:8px; border:none; font-size:18px;
}
.btn {
  background:#0f0; color:#000; font-size:20px;
  padding:12px; width:100%; border-radius:10px;
  border:none; cursor:pointer; margin-bottom:20px;
}
.box {
  padding:10px; background:#111; border-radius:8px;
  margin-top:15px; word-break:break-all;
  font-size:17px;
}
</style>
</head>
<body>

<h2>Extractor Panel</h2>

<input id="url" placeholder="Masukkan Link YouTube / HLS / DASH">

<button class="btn" onclick="extract()">EXTRACT</button>

<div id="result"></div>

<script>
async function extract() {
  const url = document.getElementById("url").value.trim();
  if (!url) return alert("Masukkan link dulu bos.");

  document.getElementById("result").innerHTML = "Processing...";

  const api = "/api/extract?url=" + encodeURIComponent(url);
  const res = await fetch(api);
  const data = await res.json();

  let out = "";

  if (data.best) out += "<div class='box'><b>BEST STREAM:</b><br>"+data.best+"</div>";
  if (data.master) out += "<div class='box'><b>MASTER STREAM:</b><br>"+data.master+"</div>";

  if (data.streams) {
    out += "<h3>All Streams:</h3>";
    data.streams.forEach(s=>{
      out += "<div class='box'>"+s+"</div>";
    });
  }

  document.getElementById("result").innerHTML = out;
}
</script>

</body>
</html>
`;
