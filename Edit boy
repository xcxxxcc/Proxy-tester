export default {
  async fetch(request) {
    try {
      const url = new URL(request.url);
      const target = url.searchParams.get("url");

      if (!target) {
        return new Response("Missing ?url=", { status: 400 });
      }

      // Fetch ke YouTube HLS / segmen
      const resp = await fetch(target, {
        headers: {
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36",
          "Accept": "*/*",
          "Accept-Language": "en-US,en;q=0.9",
        },
      });

      // Clone headers
      const newHeaders = new Headers(resp.headers);

      // Force MIME type agar HLS bisa play
      if (target.endsWith(".m3u8")) {
        newHeaders.set("Content-Type", "application/vnd.apple.mpegurl");
      } else if (target.endsWith(".ts") || target.endsWith(".m4s")) {
        newHeaders.set("Content-Type", "video/mp2t");
      }

      newHeaders.set("Access-Control-Allow-Origin", "*");
      newHeaders.set("Access-Control-Allow-Headers", "*");
      newHeaders.set("Cache-Control", "no-cache");

      return new Response(resp.body, {
        status: resp.status,
        headers: newHeaders,
      });

    } catch (err) {
      return new Response("Worker Error: " + err.toString(), {
        status: 500,
      });
    }
  },
};
